{% extends 'base.html' %}
{% load static %}
{% block title %}My Orders | Urban Laundromat{% endblock %}

{% block extra_head %}
<style>
  body {
    background: #f8f9fa;
    font-family: 'Poppins', sans-serif;
  }

  .dashboard-header {
    background: linear-gradient(135deg, #004aad, #007bff);
    color: white;
    padding: 40px 20px;
    border-radius: 0 0 40px 40px;
    text-align: center;
    animation: fadeIn 1s ease-in-out;
  }

  .dashboard-header h2 {
    font-weight: 700;
  }

  .orders-section {
    padding: 50px 0;
    animation: slideUp 0.8s ease-in-out;
  }

  @keyframes slideUp {
    from { opacity: 0; transform: translateY(40px); }
    to { opacity: 1; transform: translateY(0); }
  }

  .status.pending { background: #fff3cd; color: #856404; border-left-color: #ffc107; }
  .status.picked_up { background: #d4edda; color: #155724; border-left-color: #28a745; }
  .status.washing { background: #cce5ff; color: #004085; border-left-color: #007bff; }
  .status.ironing { background: #f3d9fa; color: #6f42c1; border-left-color: #6f42c1; }
  .status.delivered { background: #d1ecf1; color: #0c5460; border-left-color: #17a2b8; }

  .progress {
    height: 8px;
    border-radius: 5px;
    background-color: #e9ecef;
  }

  .progress-bar {
    background-color: #004aad;
    transition: width 0.6s ease;
  }

  .action-btn {
    background: white;
    color: #004aad;
    border: 2px solid #004aad;
    border-radius: 12px;
    padding: 8px 16px;
    transition: 0.3s;
    font-weight: 600;
  }

  .action-btn:hover {
    background: #004aad;
    color: white;
  }

  .logout-btn {
    position: absolute;
    top: 25px;
    right: 25px;
    background: #fff;
    border-radius: 10px;
    color: #004aad;
    font-weight: 600;
    padding: 8px 14px;
    border: none;
    box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    transition: 0.3s;
  }

  .logout-btn:hover {
    background: #004aad;
    color: white;
  }

  .empty-state img {
    width: 180px;
    opacity: 0.7;
  }

  .modal-content {
    border-radius: 15px;
  }

  #loadingSpinner {
    display: none;
  }
</style>
{% endblock %}

{% block content %}
<section class="dashboard-header position-relative">
  <button class="logout-btn" id="logoutBtn">Logout</button>
  <h2>Welcome, <span id="usernameDisplay">Customer</span> üëã</h2>
  <p class="mb-0">Track and manage your laundry orders below.</p>
  <div class="mt-3">
    <button class="action-btn" id="refreshOrders">üîÑ Refresh</button>
    <button class="action-btn" data-bs-toggle="modal" data-bs-target="#newOrderModal">‚ûï New Order</button>
  </div>
</section>

<section class="orders-section container">
  <div id="loadingSpinner" class="text-center mt-5">
    <div class="spinner-border text-primary" role="status"></div>
    <p class="text-muted mt-2">Loading your orders...</p>
  </div>
  <div id="ordersContainer" class="row g-4 justify-content-center"></div>
</section>

<!-- üß∫ New Order Modal -->
<div class="modal fade" id="newOrderModal" tabindex="-1" aria-labelledby="newOrderModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content p-3">
      <div class="modal-header">
        <h5 class="modal-title fw-bold" id="newOrderModalLabel">Create New Laundry Order</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="newOrderForm">
          <div class="mb-3">
            <label class="form-label">Service Type</label>
            <select id="service_type" class="form-select" required>
              <option value="">Select...</option>
              <option value="wash">Wash</option>
              <option value="dry_clean">Dry Clean</option>
              <option value="iron">Iron</option>
              <option value="fold">Fold</option>
            </select>
          </div>
          <div class="mb-3">
            <label class="form-label">Pickup Address</label>
            <input type="text" id="pickup_address" class="form-control" placeholder="e.g. 123 Kenyatta Ave" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Delivery Address</label>
            <input type="text" id="delivery_address" class="form-control" placeholder="e.g. 45 Moi Road" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Total Price (KES)</label>
            <input type="number" id="total_price" class="form-control" placeholder="Enter amount" required>
          </div>
          <button type="submit" class="btn btn-primary w-100">Submit Order</button>
        </form>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener("DOMContentLoaded", () => {
  const token = localStorage.getItem("access");
  const usernameDisplay = document.getElementById("usernameDisplay");

  if (!token) {
    alert("‚ö†Ô∏è Please login to access your dashboard.");
    window.location.href = "/login/";
    return;
  }

  // Display username if saved in storage
  usernameDisplay.textContent = localStorage.getItem("username") || "Customer";

  fetchOrders();
});

async function fetchOrders() {
  const spinner = document.getElementById("loadingSpinner");
  spinner.style.display = "block";

  const token = localStorage.getItem("access");
  try {
    const response = await axios.get("http://127.0.0.1:8100/api/orders/", {
      headers: { Authorization: `Bearer ${token}` }
    });
    spinner.style.display = "none";

    const orders = response.data;
    const container = document.getElementById("ordersContainer");
    container.innerHTML = "";

    if (orders.length === 0) {
      container.innerHTML = `
        <div class="empty-state">
          <img src="{% static 'assets/img/empty_orders.svg' %}" alt="No orders">
          <p class="mt-3">No orders yet. Click ‚Äú‚ûï New Order‚Äù to create one.</p>
        </div>`;
      return;
    }

    orders.forEach(order => {
      const progress = getProgress(order.status);
      const card = `
        <div class="col-md-5">
          <div class="order-card p-4 status ${order.status}">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <h5 class="fw-bold mb-0">Order #${order.id}</h5>
              <span class="status ${order.status}">${order.status.replace('_', ' ')}</span>
            </div>
            <p><strong>Service:</strong> ${order.service_type}</p>
            <p><strong>Pickup:</strong> ${order.pickup_address}</p>
            <p><strong>Delivery:</strong> ${order.delivery_address}</p>
            <p><strong>Total:</strong> KES ${order.total_price}</p>
            <div class="progress mb-2">
              <div class="progress-bar" style="width: ${progress}%"></div>
            </div>
            <small class="text-muted">Last updated: ${new Date(order.updated_at).toLocaleString()}</small>
          </div>
        </div>`;
      container.innerHTML += card;
    });
  } catch (error) {
    spinner.style.display = "none";
    console.error(error.response?.data || error);
    alert("‚ùå Failed to load orders.");
  }
}

function getProgress(status) {
  switch (status) {
    case "pending": return 15;
    case "picked_up": return 40;
    case "washing": return 65;
    case "ironing": return 85;
    case "delivered": return 100;
    default: return 0;
  }
}

document.getElementById("refreshOrders").addEventListener("click", fetchOrders);

document.getElementById("newOrderForm").addEventListener("submit", async (e) => {
  e.preventDefault();
  const token = localStorage.getItem("access");
  const data = {
    service_type: document.getElementById("service_type").value,
    pickup_address: document.getElementById("pickup_address").value,
    delivery_address: document.getElementById("delivery_address").value,
    total_price: document.getElementById("total_price").value
  };

  try {
    await axios.post("http://127.0.0.1:8100/api/orders/", data, {
      headers: { Authorization: `Bearer ${token}` }
    });
    alert("‚úÖ Order created successfully!");
    bootstrap.Modal.getInstance(document.getElementById("newOrderModal")).hide();
    fetchOrders();
  } catch (error) {
    console.error(error.response?.data || error);
    alert("‚ùå Failed to create order.");
  }
});

// Logout functionality
document.getElementById("logoutBtn").addEventListener("click", () => {
  localStorage.removeItem("access");
  localStorage.removeItem("refresh");
  window.location.href = "/login/";
});
</script>
{% endblock %}
