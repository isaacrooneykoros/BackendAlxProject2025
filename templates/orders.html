{% extends 'base.html' %}
{% load static %}
{% block title %}My Orders | Urban Laundromat{% endblock %}

{% block extra_head %}
<style>
  body {
    background: #f8f9fa;
    font-family: 'Poppins', sans-serif;
  }

  .dashboard-header {
    background: linear-gradient(to right, #004aad, #007bff);
    color: white;
    padding: 40px 20px;
    border-radius: 0 0 40px 40px;
    text-align: center;
    animation: fadeIn 1s ease-in-out;
  }

  .dashboard-header h2 {
    font-weight: 700;
  }

  .orders-section {
    padding: 50px 0;
    animation: slideUp 0.8s ease-in-out;
  }

  @keyframes slideUp {
    from { opacity: 0; transform: translateY(40px); }
    to { opacity: 1; transform: translateY(0); }
  }

  .order-card {
    background: #fff;
    border-radius: 15px;
    box-shadow: 0 8px 25px rgba(0,0,0,0.1);
    transition: transform 0.3s;
  }

  .order-card:hover {
    transform: translateY(-5px);
  }

  .status {
    font-weight: 600;
    border-radius: 12px;
    padding: 4px 10px;
  }

  .status.pending { background: #ffe5b4; color: #b36b00; }
  .status.picked_up { background: #d0f0c0; color: #2b7a0b; }
  .status.washing { background: #cce5ff; color: #004085; }
  .status.ironing { background: #f3d9fa; color: #800080; }
  .status.delivered { background: #d4edda; color: #155724; }

  .progress {
    height: 8px;
    border-radius: 5px;
  }

  .progress-bar {
    background-color: #004aad;
    transition: width 0.6s ease;
  }

  .refresh-btn {
    background: #004aad;
    color: #fff;
    border: none;
    border-radius: 12px;
    padding: 8px 16px;
    transition: 0.3s;
  }

  .refresh-btn:hover {
    background: #003580;
  }
</style>
{% endblock %}

{% block content %}
<section class="dashboard-header">
  <h2>Welcome, <span id="usernameDisplay">Customer</span> ðŸ‘‹</h2>
  <p class="mb-0">Hereâ€™s an overview of your laundry orders.</p>
  <button class="refresh-btn mt-3" id="refreshOrders">ðŸ”„ Refresh Orders</button>
</section>

<section class="orders-section container">
  <div id="ordersContainer" class="row g-4 justify-content-center">
    <!-- Orders will be loaded here -->
  </div>
</section>
{% endblock %}

{% block scripts %}
<script>
async function fetchOrders() {
  const token = localStorage.getItem("access");
  if (!token) {
    alert("Please log in first!");
    window.location.href = "/login/";
    return;
  }

  try {
    const response = await axios.get("http://127.0.0.1:8100/api/orders/", {
      headers: { Authorization: `Bearer ${token}` }
    });

    const orders = response.data;
    const container = document.getElementById("ordersContainer");
    container.innerHTML = "";

    if (orders.length === 0) {
      container.innerHTML = "<p class='text-center text-muted'>No orders yet. Place your first laundry order!</p>";
      return;
    }

    orders.forEach(order => {
      const progressPercent = getProgress(order.status);
      const card = `
        <div class="col-md-5">
          <div class="card order-card p-4">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <h5 class="fw-bold mb-0">Order #${order.id}</h5>
              <span class="status ${order.status}">${order.status.replace('_', ' ').toUpperCase()}</span>
            </div>
            <p class="mb-1"><strong>Service:</strong> ${order.service_type}</p>
            <p class="mb-1"><strong>Pickup:</strong> ${order.pickup_address}</p>
            <p class="mb-1"><strong>Delivery:</strong> ${order.delivery_address}</p>
            <p class="mb-2"><strong>Total:</strong> KES ${order.total_price}</p>

            <div class="progress mb-2">
              <div class="progress-bar" style="width: ${progressPercent}%"></div>
            </div>
            <small class="text-muted">Updated: ${new Date(order.updated_at).toLocaleString()}</small>
          </div>
        </div>`;
      container.innerHTML += card;
    });
  } catch (error) {
    console.error(error.response?.data || error);
    alert("Failed to load orders.");
  }
}

function getProgress(status) {
  switch (status) {
    case "pending": return 10;
    case "picked_up": return 40;
    case "washing": return 60;
    case "ironing": return 80;
    case "delivered": return 100;
    default: return 0;
  }
}

document.getElementById("refreshOrders").addEventListener("click", fetchOrders);
document.addEventListener("DOMContentLoaded", fetchOrders);
</script>
{% endblock %}
